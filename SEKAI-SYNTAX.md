# SEKAI è¯­æ³•è§„èŒƒ

**Structured Extensible Keyword for Advanced Interactions**

Nightcord çš„å¯æ‰©å±•å¯Œæ–‡æœ¬æ ‡è®°è¯­è¨€ï¼Œæä¾›ç»Ÿä¸€ã€å‘åå…¼å®¹çš„å¯Œåª’ä½“å’Œæ–‡æœ¬æ ¼å¼åŒ–èƒ½åŠ›ã€‚

## è®¾è®¡åŸåˆ™

1. **å‘åå…¼å®¹** - æ—§å®¢æˆ·ç«¯çœ‹åˆ°çš„æ˜¯å¯è¯»æ–‡æœ¬
2. **ç»Ÿä¸€æ ¼å¼** - `[Type:Data]` æ¨¡å¼æ˜“äºè§£æå’Œæ‰©å±•
3. **çº¯å®¢æˆ·ç«¯** - æ— éœ€ä¿®æ”¹æœåŠ¡ç«¯ï¼Œæ¶ˆæ¯å­˜å‚¨ä¸ºçº¯æ–‡æœ¬
4. **æ¸è¿›å¢å¼º** - æ–°å®¢æˆ·ç«¯é€æ­¥æ¸²æŸ“å¯Œæ–‡æœ¬
5. **é˜²æ­¢è¯¯è§¦å‘** - æ˜ç¡®çš„è¯­æ³•è§„åˆ™ï¼Œé¿å…æ—¥å¸¸æ–‡æœ¬æ„å¤–æ ¼å¼åŒ–

## è¯­æ³•è§„èŒƒ

### 1. åŸºç¡€å¯Œåª’ä½“

ç»Ÿä¸€æ ¼å¼ï¼š`[Type:Data]` æˆ– `[Type:Data|Metadata]`

#### 1.1 å›¾ç‰‡ (Image)
```
[img:URL]
[img:URL|AltText]
```

**ç¤ºä¾‹ï¼š**
```
[img:https://example.com/photo.jpg]
[img:https://example.com/photo.jpg|æˆ‘çš„ç…§ç‰‡]
```

**æ¸²æŸ“ï¼š**
- å†…è”æ˜¾ç¤ºå›¾ç‰‡ï¼Œæ”¯æŒæ‡’åŠ è½½
- Alt æ–‡æœ¬ä½œä¸º img çš„ alt å’Œ title å±æ€§

#### 1.2 æ–‡ä»¶ (File)
```
[file:ID|FileName|Size]
```

**ç¤ºä¾‹ï¼š**
```
[file:https://example.com/doc.pdf|é¡¹ç›®æ–‡æ¡£.pdf|2.5MB]
[file:abc123|æŠ¥å‘Š.docx|1.2MB]
```

**æ¸²æŸ“ï¼š**
- æ–‡ä»¶å¡ç‰‡ UIï¼ˆå›¾æ ‡ + æ–‡ä»¶å + å¤§å°ï¼‰
- ç‚¹å‡»ä¸‹è½½æˆ–æ‰“å¼€

#### 1.3 éŸ³é¢‘ (Audio)
```
[audio:ID|Duration]
[audio:URL|Duration]
```

**ç¤ºä¾‹ï¼š**
```
[audio:https://example.com/music.mp3|3:45]
[audio:abc123|2:30]
```

**æ¸²æŸ“ï¼š**
- éŸ³é¢‘æ’­æ”¾å™¨æ§ä»¶
- æ˜¾ç¤ºæ—¶é•¿

#### 1.4 Stamp/Sticker
```
[stamp:ID]
```

**è¯­æ³•ç³–ï¼ˆå‘åå…¼å®¹ï¼‰ï¼š**
```
[stamp0000]  â†’ è§£æä¸º [stamp:0000]
[xxx]        â†’ è§£æä¸º [stamp:xxx]ï¼ˆå¦‚æœä¸æ˜¯å…¶ä»–å·²çŸ¥ç±»å‹ï¼‰
```

**ç¤ºä¾‹ï¼š**
```
[stamp:0806]
[stamp0806]    â† è¯­æ³•ç³–
[smile]        â† è¯­æ³•ç³–ï¼ˆå¦‚æœ smile æ˜¯å·²çŸ¥ stickerï¼‰
```

**æ¸²æŸ“ï¼š**
- å¤ç”¨ç°æœ‰ StickerService
- å•ç‹¬ stamp æ˜¾ç¤ºå¤§å°ºå¯¸ï¼Œè¡Œå†…æ˜¾ç¤ºå°å°ºå¯¸

### 2. æ–‡æœ¬æ ¼å¼åŒ–

ä½¿ç”¨ç±» Markdown è¯­æ³•ï¼Œä¸ç°æœ‰æ ¼å¼ä¸å†²çªã€‚

#### 2.1 ç²—ä½“
```
**åŠ ç²—æ–‡æœ¬**
```

#### 2.2 æ–œä½“
```
*æ–œä½“æ–‡æœ¬*
```

#### 2.3 åˆ é™¤çº¿
```
~~åˆ é™¤çš„æ–‡æœ¬~~
```

#### 2.4 é»‘å¹•/é˜²å‰§é€
```
||å‰§é€å†…å®¹ç‚¹å‡»æ˜¾ç¤º||
```

**æ¸²æŸ“ï¼š**
- é»˜è®¤é»‘è‰²èƒŒæ™¯é®æŒ¡
- ç‚¹å‡»æˆ– hover æ˜¾ç¤ºå†…å®¹
- æ”¯æŒ `.revealed` ç±»æŒä¹…æ˜¾ç¤º

#### 2.5 å¼•ç”¨
```
> è¿™æ˜¯å¼•ç”¨çš„æ–‡æœ¬
> å¯ä»¥å¤šè¡Œ
```

#### 2.6 è¡Œå†…ä»£ç 
```
`code here`
```

**æ³¨æ„ï¼š**
- ä¸æ”¯æŒä»£ç å—ï¼ˆå¤šè¡Œ ```ï¼‰ï¼Œé¿å…å¤æ‚æ€§
- è¡Œå†…ä»£ç è¶³å¤Ÿæ»¡è¶³æ—¥å¸¸ä½¿ç”¨

### 3. é«˜çº§äº¤äº’

#### 3.1 å›å¤å¼•ç”¨
```
[re:Timestamp]
[re:Timestamp|é¢„è§ˆæ–‡æœ¬]
```

**ç¤ºä¾‹ï¼š**
```
[re:1234567890]
[re:1234567890|åŸæ¶ˆæ¯ï¼šä½ å¥½å—ï¼Ÿ]
```

**æ¸²æŸ“ï¼š**
- æ˜¾ç¤ºå›å¤å¼•ç”¨å¡ç‰‡
- ç‚¹å‡»è·³è½¬åˆ°åŸæ¶ˆæ¯ï¼ˆå¦‚æœå¯è§ï¼‰
- å¦‚æœæœ‰é¢„è§ˆæ–‡æœ¬ï¼Œæ˜¾ç¤ºåŸæ¶ˆæ¯ç‰‡æ®µ

#### 3.2 é“¾æ¥å¡ç‰‡
```
[link:URL|Title]
[link:URL|Title|Description]
```

**ç¤ºä¾‹ï¼š**
```
[link:https://example.com|Example ç½‘ç«™]
[link:https://github.com|GitHub|ä»£ç æ‰˜ç®¡å¹³å°]
```

**æ¸²æŸ“ï¼š**
- å¸¦æ ‡é¢˜çš„é“¾æ¥å¡ç‰‡
- å¯é€‰æè¿°æ–‡æœ¬
- åŒºåˆ«äºæ™®é€šè‡ªåŠ¨é“¾æ¥

#### 3.3 å½©è‰²æ–‡å­—
```
[color:hex|æ–‡æœ¬]
[color:#hex|æ–‡æœ¬]
```

**ç¤ºä¾‹ï¼š**
```
[color:ff0000|çº¢è‰²æ–‡å­—]
[color:#00ff00|ç»¿è‰²æ–‡å­—]
```

**æ¸²æŸ“ï¼š**
- åº”ç”¨æŒ‡å®šé¢œè‰²
- æ”¯æŒ 3/6 ä½ hex é¢œè‰²
- å¯é€‰ `#` å‰ç¼€

### 4. ç‰¹æ®Šè§„åˆ™

#### 4.1 AI äººè®¾å‰ç¼€ï¼ˆå·²æœ‰ç³»ç»Ÿï¼‰
```
[Nako]æ¶ˆæ¯å†…å®¹
[Asagi]æ¶ˆæ¯å†…å®¹
[Miku]æ¶ˆæ¯å†…å®¹
[æ±¤å·å”¯]æ¶ˆæ¯å†…å®¹
```

**å¤„ç†ï¼š**
- åœ¨ SEKAI è§£æå‰å·²è¢« nightcord-mgr.js ç§»é™¤
- ä¸å‚ä¸ SEKAI ä»¤ç‰Œè§£æ

#### 4.2 @mentionï¼ˆå·²æœ‰ç³»ç»Ÿï¼‰
```
@ç”¨æˆ·å
```

**å¤„ç†ï¼š**
- è‡ªåŠ¨è¡¥å…¨å·²æ”¯æŒ
- æœªæ¥å¯æ‰©å±•ä¸ºé«˜äº®æ˜¾ç¤º

#### 4.3 è‡ªåŠ¨é“¾æ¥
```
https://example.com
http://example.com
```

**æ¸²æŸ“ï¼š**
- è‡ªåŠ¨æ£€æµ‹ URL å¹¶è½¬ä¸ºå¯ç‚¹å‡»é“¾æ¥
- ä½¿ç”¨ markdown-it linkify åŠŸèƒ½

## è§£ææµç¨‹

### å½“å‰æµç¨‹ï¼ˆæ—§ç‰ˆï¼‰
```
1. æ£€æµ‹ AI å‰ç¼€ â†’ ç§»é™¤å¹¶æ”¹å˜å‘é€è€…
2. Pangu å¤„ç† â†’ ä¿æŠ¤ [sticker]
3. Sticker æ¸²æŸ“ â†’ [name] è½¬ä¸º <img>
4. æ˜¾ç¤º â†’ textContent æˆ– DocumentFragment
```

### æ–°æµç¨‹ï¼ˆSEKAIï¼‰
```
1. AI å‰ç¼€æ£€æµ‹ï¼ˆnightcord-mgr.jsï¼Œä¿æŒä¸å˜ï¼‰
   â†“
2. SEKAI è§£æï¼ˆæ–°å¢ sekai-renderer.jsï¼‰
   a. æ ‡å‡†åŒ–è¯­æ³•ç³–
      [stamp0000] â†’ [stamp:0000]
      [xxx] â†’ [stamp:xxx]ï¼ˆæ’é™¤ type:data å’Œ AI åç§°ï¼‰
   b. ä»¤ç‰ŒåŒ–ï¼ˆtokenizeï¼‰
      åˆ†ç¦» SEKAI ä»¤ç‰Œ [type:data] å’Œçº¯æ–‡æœ¬å—
   c. æ–‡æœ¬æ ¼å¼åŒ–
      å¤„ç† ** * ~~ || > ` ç­‰ Markdown è¯­æ³•
   â†“
3. æ¸²æŸ“ï¼ˆrenderï¼‰
   a. SEKAI ä»¤ç‰Œ â†’ DOM å…ƒç´ ï¼ˆimg/file card/audio playerï¼‰
   b. çº¯æ–‡æœ¬ â†’ Markdown å¤„ç† â†’ Pangu â†’ TextNode
   â†“
4. ç»„è£… DocumentFragment
```

## å®‰å…¨æ€§

### XSS é˜²æŠ¤
- ä½¿ç”¨ DOMPurify æ¸…ç†æ‰€æœ‰ HTML
- URL ç™½åå•ï¼ˆå¯é€‰ï¼‰
- ç¦æ­¢ `javascript:` åè®®

### æ ‡ç­¾ç™½åå•
```javascript
const ALLOWED_TAGS = [
  'strong', 'em', 'del', 'code',    // æ–‡æœ¬æ ¼å¼
  'blockquote', 'br',                // å¼•ç”¨ã€æ¢è¡Œ
  'span',                             // å½©è‰²æ–‡å­—ã€é»‘å¹•
  'img', 'audio',                     // å¯Œåª’ä½“
  'a'                                 // é“¾æ¥
];

const ALLOWED_ATTR = {
  'img': ['src', 'alt', 'title', 'class', 'loading'],
  'a': ['href', 'target', 'rel', 'class'],
  'span': ['class', 'style', 'data-*'],
  'audio': ['src', 'controls', 'class'],
  '*': ['class']
};
```

## å®ç°è®¡åˆ’

### Phase 1: æ ¸å¿ƒè§£æå™¨ âœ… TODO
- [ ] åˆ›å»º `sekai-renderer.js`
- [ ] å®ç° `SekaiRenderer` ç±»
  - [ ] `normalizeSyntaxSugar()` - è¯­æ³•ç³–æ ‡å‡†åŒ–
  - [ ] `tokenize()` - ä»¤ç‰ŒåŒ–è§£æ
  - [ ] `render()` - æ¸²æŸ“ä¸º DocumentFragment
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•ï¼ˆå¯é€‰ï¼‰

### Phase 2: åŸºç¡€å¯Œåª’ä½“ â³ TODO
- [ ] `[stamp:ID]` æ¸²æŸ“
  - [ ] å¤ç”¨ç°æœ‰ StickerService
  - [ ] è¯­æ³•ç³–å…¼å®¹ `[stamp0000]` â†’ `[stamp:0000]`
  - [ ] è¯­æ³•ç³–å…¼å®¹ `[xxx]` â†’ `[stamp:xxx]`
- [ ] `[img:URL]` / `[img:URL|Alt]`
  - [ ] å†…è”å›¾ç‰‡æ˜¾ç¤º
  - [ ] æ‡’åŠ è½½æ”¯æŒ
  - [ ] é”™è¯¯å¤„ç†ï¼ˆåŠ è½½å¤±è´¥æ˜¾ç¤º altï¼‰
- [ ] `[file:ID|Name|Size]`
  - [ ] æ–‡ä»¶å¡ç‰‡ UI ç»„ä»¶
  - [ ] æ–‡ä»¶å›¾æ ‡ï¼ˆæ ¹æ®æ‰©å±•åï¼‰
  - [ ] ç‚¹å‡»ä¸‹è½½åŠŸèƒ½
- [ ] `[audio:ID|Duration]`
  - [ ] HTML5 audio æ§ä»¶
  - [ ] è‡ªå®šä¹‰æ’­æ”¾å™¨æ ·å¼ï¼ˆå¯é€‰ï¼‰

### Phase 3: æ–‡æœ¬æ ¼å¼åŒ– â³ TODO
- [ ] é›†æˆ markdown-itï¼ˆè½»é‡ Markdown è§£æå™¨ï¼‰
- [ ] é…ç½® markdown-it
  - [ ] ç¦ç”¨ä¸éœ€è¦çš„åŠŸèƒ½ï¼ˆheading, image, table ç­‰ï¼‰
  - [ ] å¯ç”¨ linkifyï¼ˆè‡ªåŠ¨é“¾æ¥ï¼‰
  - [ ] å¯ç”¨ breaksï¼ˆæ¢è¡Œè½¬ `<br>`ï¼‰
- [ ] å®ç°åŸºç¡€æ ¼å¼
  - [ ] `**ç²—ä½“**` â†’ `<strong>`
  - [ ] `*æ–œä½“*` â†’ `<em>`
  - [ ] `~~åˆ é™¤çº¿~~` â†’ `<del>`
  - [ ] `` `ä»£ç ` `` â†’ `<code>`
  - [ ] `> å¼•ç”¨` â†’ `<blockquote>`
- [ ] å®ç°é»‘å¹• `||spoiler||`
  - [ ] è‡ªå®šä¹‰è§£æè§„åˆ™
  - [ ] CSS æ ·å¼ï¼ˆé»‘è‰²é®æŒ¡ï¼‰
  - [ ] ç‚¹å‡»/hover äº¤äº’
- [ ] ä¸ Pangu é›†æˆ
  - [ ] ä¿æŠ¤ SEKAI ä»¤ç‰Œä¸è¢« Pangu å¤„ç†
  - [ ] ä¿æŠ¤ Markdown è¯­æ³•ä¸è¢«ç ´å

### Phase 4: é«˜çº§äº¤äº’ â³ TODO
- [ ] `[re:timestamp]` å›å¤å¼•ç”¨
  - [ ] æ¶ˆæ¯ç´¢å¼•ç»´æŠ¤ï¼ˆtimestamp â†’ messageï¼‰
  - [ ] å›å¤å¡ç‰‡ UI
  - [ ] ç‚¹å‡»è·³è½¬åŠŸèƒ½
  - [ ] é¢„è§ˆæ–‡æœ¬æ”¯æŒ `[re:ts|preview]`
- [ ] `[link:URL|Title]` é“¾æ¥å¡ç‰‡
  - [ ] é“¾æ¥å¡ç‰‡ UI ç»„ä»¶
  - [ ] æè¿°æ–‡æœ¬æ”¯æŒ
  - [ ] Open Graph é¢„è§ˆï¼ˆå¯é€‰ï¼Œéœ€è¦æœåŠ¡ç«¯ï¼‰
- [ ] `[color:hex|text]` å½©è‰²æ–‡å­—
  - [ ] hex é¢œè‰²è§£æï¼ˆæ”¯æŒ 3/6 ä½ï¼Œå¸¦/ä¸å¸¦ `#`ï¼‰
  - [ ] åº”ç”¨å†…è”æ ·å¼æˆ– CSS å˜é‡
  - [ ] é¢œè‰²å¯¹æ¯”åº¦æ£€æŸ¥ï¼ˆç¡®ä¿å¯è¯»æ€§ï¼‰

### Phase 5: é›†æˆä¸ä¼˜åŒ– â³ TODO
- [ ] æ›¿æ¢ ui-manager.js ä¸­çš„ StickerService è°ƒç”¨
  - [ ] `createMessageElement()` ä½¿ç”¨ SekaiRenderer
  - [ ] `appendStreamingContent()` æ”¯æŒ SEKAI è¯­æ³•
  - [ ] `finishStreamingMessage()` æ”¯æŒ SEKAI è¯­æ³•
- [ ] æ·»åŠ  DOMPurify
  - [ ] åŠ è½½ DOMPurify åº“
  - [ ] é…ç½®ç™½åå•
  - [ ] XSS è¿‡æ»¤
- [ ] æ€§èƒ½ä¼˜åŒ–
  - [ ] ç¼“å­˜è§£æç»“æœï¼ˆå¯é€‰ï¼‰
  - [ ] æ‡’åŠ è½½å›¾ç‰‡/éŸ³é¢‘
  - [ ] è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¤§é‡æ¶ˆæ¯æ—¶ï¼‰
- [ ] CSS æ ·å¼
  - [ ] å¯Œåª’ä½“å…ƒç´ æ ·å¼
  - [ ] æ–‡æœ¬æ ¼å¼æ ·å¼
  - [ ] å“åº”å¼è®¾è®¡ï¼ˆç§»åŠ¨ç«¯ï¼‰
- [ ] æµ‹è¯•
  - [ ] å…¼å®¹æ€§æµ‹è¯•ï¼ˆæ—§å®¢æˆ·ç«¯ï¼‰
  - [ ] è¾¹ç•Œæƒ…å†µæµ‹è¯•
  - [ ] æ€§èƒ½æµ‹è¯•

## ç¤ºä¾‹

### å®Œæ•´æ¶ˆæ¯ç¤ºä¾‹
```
å¤§å®¶å¥½ï¼

è¿™æ˜¯**ç²—ä½“**å’Œ*æ–œä½“*æ–‡å­—ï¼Œè¿˜æœ‰~~åˆ é™¤çº¿~~ã€‚

æˆ‘å‘ç°äº†ä¸€ä¸ªæœ‰è¶£çš„é“¾æ¥ï¼šhttps://github.com

è¿™æ˜¯è¡Œå†…ä»£ç ï¼š`const x = 42;`

> å¼•ç”¨çš„æ–‡å­—
> å¯ä»¥å¤šè¡Œ

åˆ†äº«ä¸€å¼ å›¾ç‰‡ï¼š[img:https://example.com/photo.jpg|æˆ‘çš„ç…§ç‰‡]

å‘é€ä¸€ä¸ªè¡¨æƒ…ï¼š[stamp:0806]

||è¿™æ˜¯å‰§é€å†…å®¹ï¼Œç‚¹å‡»æŸ¥çœ‹||

æ–‡ä»¶åˆ†äº«ï¼š[file:https://example.com/doc.pdf|æ–‡æ¡£.pdf|2.5MB]

[color:ff0000|çº¢è‰²çš„é‡ç‚¹æ–‡å­—]

å›å¤æ¥¼ä¸Šï¼š[re:1234567890|åŸæ¶ˆæ¯å†…å®¹]
```

### æ—§å®¢æˆ·ç«¯æ˜¾ç¤ºï¼ˆå‘åå…¼å®¹ï¼‰
```
å¤§å®¶å¥½ï¼

è¿™æ˜¯**ç²—ä½“**å’Œ*æ–œä½“*æ–‡å­—ï¼Œè¿˜æœ‰~~åˆ é™¤çº¿~~ã€‚

æˆ‘å‘ç°äº†ä¸€ä¸ªæœ‰è¶£çš„é“¾æ¥ï¼šhttps://github.com

è¿™æ˜¯è¡Œå†…ä»£ç ï¼š`const x = 42;`

> å¼•ç”¨çš„æ–‡å­—
> å¯ä»¥å¤šè¡Œ

åˆ†äº«ä¸€å¼ å›¾ç‰‡ï¼š[img:https://example.com/photo.jpg|æˆ‘çš„ç…§ç‰‡]

å‘é€ä¸€ä¸ªè¡¨æƒ…ï¼š[stamp:0806]

||è¿™æ˜¯å‰§é€å†…å®¹ï¼Œç‚¹å‡»æŸ¥çœ‹||

æ–‡ä»¶åˆ†äº«ï¼š[file:https://example.com/doc.pdf|æ–‡æ¡£.pdf|2.5MB]

[color:ff0000|çº¢è‰²çš„é‡ç‚¹æ–‡å­—]

å›å¤æ¥¼ä¸Šï¼š[re:1234567890|åŸæ¶ˆæ¯å†…å®¹]
```

### æ–°å®¢æˆ·ç«¯æ˜¾ç¤ºï¼ˆå¯Œæ–‡æœ¬æ¸²æŸ“ï¼‰
- **ç²—ä½“**ã€*æ–œä½“*ã€~~åˆ é™¤çº¿~~ æ­£å¸¸æ¸²æŸ“
- é“¾æ¥è‡ªåŠ¨å¯ç‚¹å‡»
- å›¾ç‰‡å†…è”æ˜¾ç¤º
- Stamp æ¸²æŸ“ä¸ºè¡¨æƒ…å›¾ç‰‡
- é»‘å¹•éœ€è¦ç‚¹å‡»æ˜¾ç¤º
- æ–‡ä»¶æ˜¾ç¤ºä¸ºå¡ç‰‡
- å½©è‰²æ–‡å­—åº”ç”¨é¢œè‰²
- å›å¤å¼•ç”¨æ˜¾ç¤ºå¡ç‰‡

## æŠ€æœ¯æ ˆ

- **markdown-it** - Markdown è§£æå™¨ï¼ˆ~20KB gzippedï¼‰
- **DOMPurify** - XSS è¿‡æ»¤å™¨ï¼ˆ~23KB gzippedï¼‰
- **ç°æœ‰ StickerService** - å¤ç”¨ stamp æ¸²æŸ“é€»è¾‘
- **Pangu.js** - ä¸­è‹±æ–‡ç©ºæ ¼ï¼ˆå·²æœ‰ï¼‰

## å…¼å®¹æ€§

- âœ… Chrome/Edge 90+
- âœ… Firefox 88+
- âœ… Safari 14+
- âœ… ç§»åŠ¨æµè§ˆå™¨ï¼ˆiOS Safari, Chrome Mobileï¼‰

## å‚è€ƒ

- [Markdown è§„èŒƒ](https://commonmark.org/)
- [BBCode å‚è€ƒ](https://www.bbcode.org/reference.php)
- [Discord Markdown](https://support.discord.com/hc/en-us/articles/210298617-Markdown-Text-101-Chat-Formatting-Bold-Italic-Underline-)
- [Telegram Bot API](https://core.telegram.org/bots/api#formatting-options)

---

**Status**: ğŸš§ In Progress
**Last Updated**: 2026-02-15
**Version**: 0.1.0
